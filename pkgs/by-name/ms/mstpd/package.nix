{
  lib,
  stdenv,
  fetchFromGitHub,
  fetchpatch,
  autoreconfHook,
}:

stdenv.mkDerivation (finalAttrs: {
  pname = "mstpd";
  version = "0.1.1";

  src = fetchFromGitHub {
    owner = "mstpd";
    repo = "mstpd";
    rev = finalAttrs.version;
    hash = "sha256-6Pc7/JnZ04vcLI30/5LBmN+hBmjD2k9kcE8g6127x0M=";
  };

  nativeBuildInputs = [ autoreconfHook ];

  configureFlags = [
    "--prefix=$(out)"
    "--sysconfdir=$(out)/etc"
    "--sbindir=$(out)/bin"
    "--libexecdir=$(out)/lib"
    "--with-bashcompletiondir=$(out)/share/bash-completion/completions"
  ];

  # bridge-stp is a helper called by the kernel whenever STP is enabled/disabled
  # on a bridge - the built-in version is incompatible with NixOS, so there's no
  # point keeping it around.
  #
  # An alternative script gets automatically generated by NixOS network module
  # whenever a bridge needs mstpd (grep for `bridgeStp`).
  postInstall = ''
    rm $out/bin/bridge-stp

    # Remove now-dangling symlinks, too
    rm $out/bin/mstp_restart
    rm $out/lib/mstpctl-utils/mstpctl_restart_config
  '';

  meta = {
    description = "Multiple Spanning Tree Protocol daemon";
    homepage = "https://github.com/mstpd/mstpd";
    license = lib.licenses.gpl2Plus;
    platforms = lib.platforms.linux;
  };
})
